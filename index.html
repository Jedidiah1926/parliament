<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>정치 시뮬레이션: 상/하원 개별 관리</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --panel-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --accent-color: #4a90e2;
            --border-color: #444;
            --input-bg: #3d3d3d;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --gold-color: #f1c40f;
            --warning-color: #f39c12;
            --tab-active-bg: #4a90e2;
            --tab-inactive-bg: #333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            gap: 20px;
            height: 100vh;
            box-sizing: border-box;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #222; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }

        .controls {
            flex: 1;
            background-color: var(--panel-bg);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            overflow-y: auto;
            max-width: 480px;
            display: flex;
            flex-direction: column;
        }

        .display-area {
            flex: 2;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }

        .chamber-box {
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        h2, h3 { margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; color: #fff; }

        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; color: #ccc; }
        input[type="number"], select, input[type="text"] {
            width: 100%;
            padding: 8px;
            background: var(--input-bg);
            border: 1px solid #555;
            color: white;
            border-radius: 4px;
            box-sizing: border-box;
        }
        input.hex-input { font-family: monospace; text-transform: uppercase; }

        /* --- 탭 스타일 --- */
        .tab-container {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }
        .tab-btn {
            flex: 1;
            padding: 10px;
            background-color: var(--tab-inactive-bg);
            color: #aaa;
            border: none;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
            font-weight: bold;
            transition: all 0.2s;
        }
        .tab-btn.active {
            background-color: var(--tab-active-bg);
            color: white;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }


        /* 카드 스타일 */
        .card-item {
            background: #363636;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 5px solid transparent;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: border 0.2s, box-shadow 0.2s;
        }
        .card-item.is-ruling {
            border: 2px solid var(--gold-color);
            box-shadow: 0 0 10px rgba(241, 196, 15, 0.3);
        }
        
        .card-header { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; }
        .color-preview { width: 25px; height: 25px; border-radius: 4px; border: 1px solid #555; flex-shrink: 0; cursor: pointer;}
        .remove-btn { 
            background-color: transparent; color: #aaa; border: 1px solid #555; 
            padding: 2px 8px; margin-left: auto; width: auto; font-size: 0.8em; 
        }
        .remove-btn:hover { background-color: var(--danger-color); color: white; border-color: var(--danger-color); }

        .party-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

        .coalition-members {
            background: #222;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
        }
        .member-check { display: flex; align-items: center; gap: 8px; padding: 4px 0; border-bottom: 1px solid #333; }
        .member-check:last-child { border-bottom: none; }
        .member-check label { margin: 0; font-weight: normal; cursor: pointer; color: #ddd; flex: 1; }
        
        .party-badge { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }

        .ruling-selector {
            display: flex; align-items: center; gap: 5px; font-size: 0.85em; cursor: pointer;
            background: #222; padding: 4px 8px; border-radius: 15px; border: 1px solid #555;
        }
        .ruling-selector input { margin: 0; cursor: pointer; }
        .ruling-selector.active { border-color: var(--gold-color); color: var(--gold-color); font-weight: bold; }

        button.add-btn { background-color: var(--success-color); width: 100%; border:none; padding:10px; color:white; border-radius:4px; cursor:pointer; margin-top: 10px; }
        button.simulate-btn { background-color: var(--accent-color); width: 100%; padding: 12px; font-size: 1.1em; margin-top: 20px; border:none; color:white; border-radius:4px; cursor:pointer; font-weight:bold;}

        canvas {
            background: radial-gradient(circle at bottom, #252525, #151515);
            border-radius: 4px;
            width: 100%; max-width: 600px; height: auto;
        }

        .stats-wrapper { margin-top: 15px; border-top: 1px solid #444; padding-top: 15px; }
        .stat-block { background: #222; padding: 12px; border-radius: 6px; border-left: 5px solid #555; margin-bottom: 10px; }
        .stat-block.gov-block { border-left: 5px solid var(--gold-color); background: linear-gradient(90deg, #2a2a20 0%, #222 100%); }
        .stat-title { font-size: 1.1em; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;}
        .stat-legend { display: flex; flex-wrap: wrap; gap: 8px; }
        .legend-pill { background: #333; padding: 4px 10px; border-radius: 12px; font-size: 0.85em; display: flex; align-items: center; gap: 6px; }
    </style>
</head>
<body>

    <div class="controls">
        <h2>설정 (Configuration)</h2>
        
        <div class="form-group">
            <div style="display:flex; gap:15px; margin-bottom: 15px;">
                <label style="font-weight:normal; color:#fff;"><input type="radio" name="systemType" value="bicameral" checked onchange="toggleSystem()"> 양원제</label>
                <label style="font-weight:normal; color:#fff;"><input type="radio" name="systemType" value="unicameral" onchange="toggleSystem()"> 단원제</label>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom: 15px; border-bottom:1px solid #444; padding-bottom:15px;">
                <div id="senateConfig">
                    <label>상원 명칭</label>
                    <input type="text" id="senateNameInput" value="상원" oninput="updateNames()">
                    <label style="margin-top:5px;">총 의석</label>
                    <input type="number" id="senateTotal" value="100">
                </div>
                <div>
                    <label id="houseNameLabel">하원 명칭</label>
                    <input type="text" id="houseNameInput" value="하원" oninput="updateNames()">
                    <label style="margin-top:5px;">총 의석</label>
                    <input type="number" id="houseTotal" value="300">
                </div>
            </div>
        </div>

        <div class="tab-container">
            <button class="tab-btn active" onclick="switchTab('house')" id="tabHouse">하원 관리</button>
            <button class="tab-btn" onclick="switchTab('senate')" id="tabSenate">상원 관리</button>
            <button class="tab-btn" onclick="switchTab('coalition')" id="tabCoalition">연정/집권</button>
        </div>

        <div id="contentHouse" class="tab-content active">
            <div id="partyListHouse"></div>
            <button class="add-btn" onclick="addParty()">+ 정당 추가</button>
        </div>

        <div id="contentSenate" class="tab-content">
            <div id="partyListSenate"></div>
            <button class="add-btn" onclick="addParty()">+ 정당 추가</button>
        </div>

        <div id="contentCoalition" class="tab-content">
            <div style="color:#888; font-size:0.9em; margin-bottom:10px;">
                * 연정 구성 및 집권 세력(Government)을 설정합니다.
            </div>
            <div id="coalitionList"></div>
            <button class="add-btn" onclick="addCoalition()">+ 연정 추가</button>
        </div>

        <button class="simulate-btn" onclick="simulate()">시뮬레이션 적용</button>
    </div>

    <div class="display-area">
        <div class="chamber-box" id="senateSection">
            <h3 id="senateTitle">상원</h3>
            <canvas id="senateCanvas"></canvas>
            <div id="senateStats" class="stats-wrapper"></div>
        </div>
        <div class="chamber-box">
            <h3 id="houseTitle">하원</h3>
            <canvas id="houseCanvas"></canvas>
            <div id="houseStats" class="stats-wrapper"></div>
        </div>
    </div>

    <script>
        const SPECTRUM_NAMES = {
            "communist": "공산주의 (극좌)", "socialist": "사회주의 (좌파)", "socdem": "사민주의 (중도좌파)",
            "liberal": "자유주의 (중도)", "conservative": "보수주의 (중도우파)", "reactionary": "반동주의 (우파)",
            "nationalist": "민족주의 (극우)", "monarchist": "왕당파", "nonaligned": "비동맹/기타", "vacant": "공석"
        };
        const SPECTRUM_KEYS = Object.keys(SPECTRUM_NAMES);
        const SPECTRUM_ORDER = SPECTRUM_KEYS.reduce((acc, key, idx) => { acc[key] = idx; return acc; }, {});

        // 데이터 구조 변경: seats -> seatsHouse, seatsSenate
        let parties = [
            { id: 1, name: "공산당", color: "#8B0000", seatsHouse: 10, seatsSenate: 2, spectrum: "communist", isRuling: false },
            { id: 2, name: "민주당", color: "#3498DB", seatsHouse: 140, seatsSenate: 45, spectrum: "liberal", isRuling: false },
            { id: 3, name: "진보당", color: "#2ECC71", seatsHouse: 20, seatsSenate: 5, spectrum: "socdem", isRuling: false },
            { id: 4, name: "공화당", color: "#E74C3C", seatsHouse: 120, seatsSenate: 48, spectrum: "conservative", isRuling: false },
            { id: 5, name: "왕당파", color: "#8E44AD", seatsHouse: 10, seatsSenate: 0, spectrum: "monarchist", isRuling: false }
        ];

        let coalitions = [
            { id: 'c1', name: "여당 연정", color: "#3498DB", members: [2, 3], isRuling: true },
            { id: 'c2', name: "야당 연합", color: "#E74C3C", members: [4, 5], isRuling: false }
        ];

        let currentTab = 'house';

        window.onload = function() { 
            toggleSystem(); 
            refreshUI();
            simulate(); 
        };

        function switchTab(tabName) {
            currentTab = tabName;
            
            // 탭 버튼 스타일
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            if(tabName === 'house') document.getElementById('tabHouse').classList.add('active');
            if(tabName === 'senate') document.getElementById('tabSenate').classList.add('active');
            if(tabName === 'coalition') document.getElementById('tabCoalition').classList.add('active');

            // 탭 컨텐츠 표시
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            if(tabName === 'house') document.getElementById('contentHouse').classList.add('active');
            if(tabName === 'senate') document.getElementById('contentSenate').classList.add('active');
            if(tabName === 'coalition') document.getElementById('contentCoalition').classList.add('active');

            refreshUI();
        }

        function toggleSystem() {
            const isBicameral = document.querySelector('input[name="systemType"]:checked').value === 'bicameral';
            
            // 상원 관련 UI 제어
            document.getElementById('senateConfig').style.display = isBicameral ? 'block' : 'none';
            document.getElementById('senateSection').style.display = isBicameral ? 'block' : 'none';
            document.getElementById('tabSenate').style.display = isBicameral ? 'block' : 'none';
            
            // 라벨 변경
            document.getElementById('houseNameLabel').textContent = isBicameral ? "하원 명칭" : "의회 명칭";
            document.getElementById('tabHouse').textContent = isBicameral ? "하원 관리" : "의석 관리";

            // 만약 단원제로 바꿨는데 현재 탭이 상원이면 하원으로 이동
            if(!isBicameral && currentTab === 'senate') switchTab('house');

            updateNames();
        }

        function updateNames() {
            const sName = document.getElementById('senateNameInput').value;
            const hName = document.getElementById('houseNameInput').value;
            
            document.getElementById('senateTitle').textContent = sName;
            document.getElementById('houseTitle').textContent = hName;
            document.getElementById('tabHouse').textContent = 
                document.querySelector('input[name="systemType"]:checked').value === 'bicameral' 
                ? hName + " 관리" : "의석 관리";
            document.getElementById('tabSenate').textContent = sName + " 관리";
        }

        function refreshUI() {
            renderPartyList('house');
            renderPartyList('senate');
            renderCoalitions();
        }

        function isValidHex(hex) { return /^#[0-9A-F]{6}$/i.test(hex); }

        // 통합 정당 리스트 렌더링 (type: 'house' or 'senate')
        function renderPartyList(type) {
            const container = document.getElementById(type === 'house' ? 'partyListHouse' : 'partyListSenate');
            container.innerHTML = '';

            parties.forEach((p, idx) => {
                const div = document.createElement('div');
                div.className = `card-item ${p.isRuling ? 'is-ruling' : ''}`;
                div.style.borderLeftColor = p.color;

                let opts = '';
                for (const [k, l] of Object.entries(SPECTRUM_NAMES)) {
                    opts += `<option value="${k}" ${p.spectrum === k ? 'selected' : ''}>${l}</option>`;
                }

                // 의석 입력 필드 결정
                const seatKey = type === 'house' ? 'seatsHouse' : 'seatsSenate';
                const seatLabel = type === 'house' ? '하원 의석' : '상원 의석';

                div.innerHTML = `
                    <div class="card-header">
                        <input type="text" value="${p.name}" onchange="updateParty(${idx}, 'name', this.value)" style="flex:1;" placeholder="당명">
                        <input type="text" class="hex-input" value="${p.color}" onchange="updatePartyColor(this, ${idx})" style="width: 60px;">
                        <div class="color-preview" style="background-color: ${p.color};"></div>
                        <button class="remove-btn" onclick="removeParty(${idx})">삭제</button>
                    </div>
                    <div class="party-grid">
                        <div>
                            <label style="color:${type==='house'?'#4a90e2':'#e67e22'}">${seatLabel}</label>
                            <input type="number" value="${p[seatKey]}" min="0" onchange="updateParty(${idx}, '${seatKey}', parseInt(this.value)||0)">
                        </div>
                        <div><label>성향</label><select onchange="updateParty(${idx}, 'spectrum', this.value)">${opts}</select></div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function renderCoalitions() {
            const container = document.getElementById('coalitionList');
            container.innerHTML = '';
            coalitions.forEach((coal, cIdx) => {
                const div = document.createElement('div');
                div.className = `card-item ${coal.isRuling ? 'is-ruling' : ''}`;
                div.style.borderLeftColor = coal.color;
                let memberChecks = '';
                parties.forEach(p => {
                    const isChecked = coal.members.includes(p.id);
                    memberChecks += `
                        <div class="member-check">
                            <span class="party-badge" style="background:${p.color}"></span>
                            <label for="c${cIdx}_p${p.id}">${p.name}</label>
                            <input type="checkbox" id="c${cIdx}_p${p.id}" 
                                ${isChecked ? 'checked' : ''} 
                                onchange="toggleCoalitionMember('${coal.id}', ${p.id}, this.checked)">
                        </div>
                    `;
                });
                div.innerHTML = `
                    <div class="card-header">
                        <input type="text" value="${coal.name}" onchange="updateCoalition('${coal.id}', 'name', this.value)" style="flex:1;" placeholder="연정 이름">
                        <input type="text" class="hex-input" value="${coal.color}" onchange="updateCoalitionColor(this, '${coal.id}')" style="width: 60px;">
                        <div class="color-preview" style="background-color: ${coal.color};"></div>
                        <button class="remove-btn" onclick="removeCoalition('${coal.id}')">삭제</button>
                    </div>
                    <label class="ruling-selector ${coal.isRuling ? 'active' : ''}" style="margin-bottom:10px;">
                        <input type="radio" name="global_ruling" ${coal.isRuling ? 'checked' : ''} onchange="setRuling('coalition', '${coal.id}')">
                        ${coal.isRuling ? '✔ 집권 연정 (Government)' : '집권 연정으로 설정'}
                    </label>
                    <div class="coalition-members">${memberChecks}</div>
                `;
                container.appendChild(div);
            });
            
            // 연정 탭에 정당별 집권 설정 기능도 추가 (단독 집권)
            const partyGovDiv = document.createElement('div');
            partyGovDiv.style.marginTop = "20px";
            partyGovDiv.style.borderTop = "1px solid #444";
            partyGovDiv.style.paddingTop = "10px";
            partyGovDiv.innerHTML = "<h4>단독 집권 설정</h4>";
            
            parties.forEach(p => {
                // 연정에 속하지 않은 당만 표시하거나 전체 표시 (여기선 전체 표시하되 연정 소속시 비활성화는 안함 - 유연성)
                const pDiv = document.createElement('div');
                pDiv.className = `ruling-selector ${p.isRuling ? 'active' : ''}`;
                pDiv.style.marginBottom = "5px";
                pDiv.innerHTML = `
                    <span class="party-badge" style="background:${p.color}"></span>
                    <span style="flex:1">${p.name}</span>
                    <input type="radio" name="global_ruling" ${p.isRuling ? 'checked' : ''} onchange="setRuling('party', ${p.id})">
                `;
                partyGovDiv.appendChild(pDiv);
            });
            container.appendChild(partyGovDiv);
        }

        // --- Data Logic ---

        function addParty() {
            parties.push({ id: Date.now(), name: "신당", color: "#999999", seatsHouse: 0, seatsSenate: 0, spectrum: "nonaligned", isRuling: false });
            refreshUI();
        }
        function removeParty(idx) {
            const pId = parties[idx].id;
            parties.splice(idx, 1);
            coalitions.forEach(c => { c.members = c.members.filter(id => id !== pId); });
            refreshUI(); simulate();
        }
        function updateParty(idx, key, val) {
            parties[idx][key] = val;
            if (key === 'name') refreshUI(); // 이름 바뀌면 양쪽 탭 다 갱신
            simulate(); // 의석수 바뀌면 즉시 시뮬레이션
        }
        function updatePartyColor(el, idx) {
            let v = el.value.trim(); if(!v.startsWith('#')) v = '#'+v;
            if(isValidHex(v)) { parties[idx].color = v.toUpperCase(); refreshUI(); simulate(); }
        }

        function addCoalition() {
            coalitions.push({ id: 'c'+Date.now(), name: "새 연정", color: "#FFFFFF", members: [], isRuling: false });
            refreshUI();
        }
        function removeCoalition(id) {
            coalitions = coalitions.filter(c => c.id !== id);
            refreshUI(); simulate();
        }
        function updateCoalition(id, key, val) {
            const c = coalitions.find(c => c.id === id); if(c) { c[key] = val; simulate(); }
        }
        function updateCoalitionColor(el, id) {
            let v = el.value.trim(); if(!v.startsWith('#')) v = '#'+v;
            if(isValidHex(v)) { 
                const c = coalitions.find(x => x.id === id); 
                if(c) { c.color = v.toUpperCase(); el.parentElement.querySelector('.color-preview').style.backgroundColor = v; simulate(); }
            }
        }
        function toggleCoalitionMember(cId, pId, checked) {
            if(checked) {
                coalitions.forEach(c => c.members = c.members.filter(id => id !== pId));
                const t = coalitions.find(c => c.id === cId); if(t) t.members.push(pId);
            } else {
                const t = coalitions.find(c => c.id === cId); if(t) t.members = t.members.filter(id => id !== pId);
            }
            refreshUI(); simulate();
        }
        function setRuling(type, id) {
            parties.forEach(p => p.isRuling = false);
            coalitions.forEach(c => c.isRuling = false);
            if(type === 'party') { const p = parties.find(x => x.id === id); if(p) p.isRuling = true; }
            else if(type === 'coalition') { const c = coalitions.find(x => x.id === id); if(c) c.isRuling = true; }
            refreshUI(); simulate();
        }

        // --- Simulation ---

        function simulate() {
            const isBicameral = document.querySelector('input[name="systemType"]:checked').value === 'bicameral';
            // 총 의석수는 사용자 입력값을 따름
            const sTotal = parseInt(document.getElementById('senateTotal').value) || 100;
            const hTotal = parseInt(document.getElementById('houseTotal').value) || 300;

            parties.sort((a, b) => SPECTRUM_ORDER[a.spectrum] - SPECTRUM_ORDER[b.spectrum]);

            // chamberType: 'seatsHouse' or 'seatsSenate'
            const getMap = (targetTotal, chamberKey) => {
                const definedTotal = parties.reduce((s, p) => s + p[chamberKey], 0);
                if(targetTotal === 0 || definedTotal === 0) return [];
                
                let map = [];
                let acc = 0;
                
                parties.forEach((p, i) => {
                    // 비율대로 배분 (입력된 의석수 합계 대비 비율 * 목표 총 의석수)
                    let count = (i === parties.length - 1) 
                        ? targetTotal - acc 
                        : Math.round((p[chamberKey] / definedTotal) * targetTotal);
                    acc += count;

                    const coal = coalitions.find(c => c.members.includes(p.id));
                    const isGov = (coal && coal.isRuling) || p.isRuling;
                    let stroke = null;
                    if(coal) stroke = coal.color;
                    else if(p.isRuling) stroke = "#f1c40f";

                    for(let k=0; k<count; k++) {
                        map.push({
                            color: p.color,
                            partyName: p.name,
                            coalitionName: coal ? coal.name : null,
                            coalitionId: coal ? coal.id : null,
                            strokeColor: stroke,
                            isRuling: isGov
                        });
                    }
                });
                while(map.length > targetTotal) map.pop();
                while(map.length < targetTotal) map.push({ color: '#333', strokeColor:null });
                return map;
            };

            const hMap = getMap(hTotal, 'seatsHouse');
            drawChamber('houseCanvas', hMap, hTotal);
            updateStats('houseStats', hMap, hTotal);

            if (isBicameral) {
                const sMap = getMap(sTotal, 'seatsSenate');
                drawChamber('senateCanvas', sMap, sTotal);
                updateStats('senateStats', sMap, sTotal);
            }
        }

        function drawChamber(canvasId, seatMap, totalSeats) {
            const canvas = document.getElementById(canvasId);
            const containerWidth = canvas.parentElement.clientWidth - 40;
            canvas.width = containerWidth;
            canvas.height = containerWidth / 2 + 50;
            const ctx = canvas.getContext('2d');
            const CX = canvas.width / 2;
            const CY = canvas.height - 25;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if(totalSeats <= 0) return;

            const minR = canvas.width * 0.18;
            const maxR = (canvas.width / 2) - 10;
            let bestConfig = null;
            let low = 2, high = 15;
            for(let i=0; i<20; i++) {
                let mid = (low + high) / 2;
                let cfg = calculateRows(mid, minR, maxR, totalSeats);
                if(cfg.totalCapacity >= totalSeats) { bestConfig = cfg; low = mid; }
                else { high = mid; }
            }
            if(!bestConfig) bestConfig = calculateRows(low, minR, maxR, totalSeats);

            const { rows, dotR } = bestConfig;
            let allPoints = [];
            let distRows = rows.map(r => ({ ...r, actual: Math.round(totalSeats * (r.circumference / bestConfig.totalCircumference)) }));
            let sum = distRows.reduce((a,b)=>a+b.actual, 0);
            distRows[distRows.length-1].actual += (totalSeats - sum);

            const startAngle = Math.PI - 0.05;
            const endAngle = 0.05;
            const span = startAngle - endAngle;

            distRows.forEach(row => {
                if(row.actual <= 0) return;
                for(let i=0; i<row.actual; i++) {
                    let ang = (row.actual===1) ? Math.PI/2 : startAngle - (span * (i / (row.actual-1)));
                    allPoints.push({
                        x: CX + row.radius * Math.cos(ang),
                        y: CY - row.radius * Math.sin(ang),
                        angle: ang
                    });
                }
            });

            allPoints.sort((a,b) => b.angle - a.angle);
            allPoints.forEach((pt, i) => {
                if(i >= seatMap.length) return;
                const d = seatMap[i];
                ctx.beginPath();
                ctx.arc(pt.x, pt.y, dotR, 0, Math.PI*2);
                ctx.fillStyle = d.color;
                ctx.fill();
                if(d.strokeColor) {
                    ctx.strokeStyle = d.strokeColor;
                    ctx.lineWidth = Math.max(1.5, dotR * 0.4);
                } else {
                    ctx.strokeStyle = "rgba(0,0,0,0.3)";
                    ctx.lineWidth = 1;
                }
                ctx.stroke();
            });
            ctx.fillStyle = "#fff"; ctx.textAlign = "center"; ctx.textBaseline = "bottom";
            ctx.font = "bold 26px Arial"; ctx.fillText(totalSeats, CX, CY - 10);
            ctx.font = "14px Arial"; ctx.fillStyle = "#888"; ctx.fillText("Total Seats", CX, CY + 10);
        }

        function calculateRows(dotR, minR, maxR, target) {
            const rowH = dotR * 2.5; const avail = maxR - minR;
            let cnt = Math.floor(avail / rowH); if(cnt < 1) cnt = 1;
            const startR = minR + (avail - cnt*rowH)/2 + dotR;
            let rows = [], cap = 0, circSum = 0;
            for(let i=0; i<cnt; i++) {
                const r = startR + i*rowH; const circ = Math.PI * r; const c = Math.floor(circ / (dotR*2.5));
                rows.push({ radius: r, capacity: c, circumference: circ }); cap += c; circSum += circ;
            }
            return { rows, totalCapacity: cap, totalCircumference: circSum, dotR };
        }

        function updateStats(elId, map, total) {
            const el = document.getElementById(elId);
            if(total === 0) { el.innerHTML = ""; return; }
            let stats = {};
            coalitions.forEach(c => { stats[c.id] = { type: 'coalition', id: c.id, name: c.name, color: c.color, count: 0, parties: {}, isRuling: c.isRuling }; });
            parties.forEach(p => { if(p.isRuling && !coalitions.some(c => c.members.includes(p.id))) { stats['p_'+p.id] = { type: 'party', id: p.id, name: p.name, color: p.color, count: 0, parties: {}, isRuling: true }; } });
            stats['none'] = { type: 'none', id: 'none', name: '무소속/기타', color: '#555', count: 0, parties: {}, isRuling: false };

            map.forEach(s => {
                let key = 'none';
                if(s.coalitionId) key = s.coalitionId;
                else if(parties.find(p => p.name === s.partyName)?.isRuling) key = 'p_' + parties.find(p => p.name === s.partyName).id;
                if(!stats[key]) key = 'none';
                stats[key].count++;
                if(!stats[key].parties[s.partyName]) stats[key].parties[s.partyName] = { n:0, col: s.color };
                stats[key].parties[s.partyName].n++;
            });

            const maj = Math.floor(total/2) + 1;
            const sortedKeys = Object.keys(stats).sort((a,b) => {
                if(stats[a].isRuling) return -1; if(stats[b].isRuling) return 1;
                if(a==='none') return 1; if(b==='none') return -1;
                return stats[b].count - stats[a].count;
            });

            let html = "";
            sortedKeys.forEach(key => {
                const group = stats[key];
                if(group.count === 0) return;
                const percent = ((group.count / total) * 100).toFixed(1);
                const isMaj = group.count >= maj;
                let statusBadge = '';
                if (group.isRuling) {
                    const govTitle = `<span style="background:var(--gold-color); color:#000; font-size:0.7em; padding:2px 6px; border-radius:4px; margin-right:5px; font-weight:bold;">GOV</span>`;
                    if (isMaj) statusBadge = `${govTitle} <span style="color:var(--success-color); font-size:0.8em; margin-left:10px;">✔ 과반 확보</span>`;
                    else statusBadge = `${govTitle} <span style="color:var(--danger-color); font-size:0.8em; margin-left:10px;">⚠ 과반 미달 (필요: ${maj})</span>`;
                } else {
                    if (isMaj) statusBadge = `<span style="color:var(--warning-color); font-size:0.8em; margin-left:10px;">⚡ 과반 장악 (여소야대)</span>`;
                }
                let legendHtml = '';
                for(const [pName, pData] of Object.entries(group.parties)) {
                    legendHtml += `<div class="legend-pill"><span class="party-badge" style="background:${pData.col}; border: 1px solid ${group.type==='coalition' ? group.color : 'transparent'}"></span>${pName}: <strong>${pData.n}</strong></div>`;
                }
                html += `<div class="stat-block ${group.isRuling ? 'gov-block' : ''}" style="border-left-color: ${group.isRuling ? 'var(--gold-color)' : group.color}"><div class="stat-title"><span><strong style="color:${group.isRuling ? 'var(--gold-color)' : group.color}">${group.name}</strong> <span style="color:#aaa; font-size:0.9em;">(${group.count}석 / ${percent}%)</span></span>${statusBadge}</div><div class="stat-legend">${legendHtml}</div></div>`;
            });
            el.innerHTML = html;
        }
    </script>
</body>
</html>