<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì •ì¹˜ ì‹œë®¬ë ˆì´ì…˜: í…Œë§ˆ ë³€ê²½ ì§€ì›</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --panel-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --accent-color: #4a90e2;
            --border-color: #444;
            --input-bg: #3d3d3d;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --gold-color: #f1c40f;
            --warning-color: #f39c12;
            --gray-btn-color: #7f8c8d;
            --theme-btn-color: #8e44ad; /* í…Œë§ˆ ë³€ê²½ ë²„íŠ¼ ìƒ‰ìƒ (ë³´ë¼ìƒ‰) */
            --tab-active-bg: #4a90e2;
            --tab-inactive-bg: #333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            gap: 20px;
            height: 100vh;
            box-sizing: border-box;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #222; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }

        .controls {
            flex: 1;
            background-color: var(--panel-bg);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            overflow-y: auto;
            max-width: 480px;
            display: flex;
            flex-direction: column;
        }

        .display-area {
            flex: 2;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }

        .chamber-box {
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        h2, h3 { margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; color: #fff; }

        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; color: #ccc; }
        input[type="number"], select, input[type="text"] {
            width: 100%;
            padding: 8px;
            background: var(--input-bg);
            border: 1px solid #555;
            color: white;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .color-input-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        input.hex-input { 
            font-family: monospace; 
            text-transform: uppercase; 
            width: 70px !important;
        }
        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 32px;
            height: 32px;
            padding: 0;
            background: none;
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: 1px solid #555; border-radius: 4px; }

        .tab-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }
        .tab-btn {
            flex: 1;
            min-width: 80px;
            padding: 10px;
            background-color: var(--tab-inactive-bg);
            color: #aaa;
            border: none;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
            font-weight: bold;
            transition: all 0.2s;
            font-size: 0.9em;
        }
        .tab-btn.active {
            background-color: var(--tab-active-bg);
            color: white;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .card-item {
            background: #363636;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 5px solid transparent;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: border 0.2s, box-shadow 0.2s;
        }
        .card-item.is-ruling {
            border: 2px solid var(--gold-color);
            box-shadow: 0 0 10px rgba(241, 196, 15, 0.3);
        }
        .card-header { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; }
        
        .btn-icon { background: none; border: 1px solid #555; color: #aaa; cursor: pointer; padding: 2px 6px; border-radius: 3px; }
        .btn-icon:hover { background: #555; color: #fff; }
        .btn-icon.danger:hover { background: var(--danger-color); border-color: var(--danger-color); }
        
        .remove-btn { 
            background-color: transparent; color: #aaa; border: 1px solid #555; 
            padding: 2px 8px; margin-left: auto; width: auto; font-size: 0.8em; 
        }
        .remove-btn:hover { background-color: var(--danger-color); color: white; border-color: var(--danger-color); }

        .party-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

        .coalition-members {
            background: #222;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
        }
        .member-check { display: flex; align-items: center; gap: 8px; padding: 4px 0; border-bottom: 1px solid #333; }
        .member-check:last-child { border-bottom: none; }
        .member-check label { margin: 0; font-weight: normal; cursor: pointer; color: #ddd; flex: 1; }
        
        .party-badge { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }

        .ruling-selector {
            display: flex; align-items: center; gap: 5px; font-size: 0.85em; cursor: pointer;
            background: #222; padding: 4px 8px; border-radius: 15px; border: 1px solid #555;
        }
        .ruling-selector input { margin: 0; cursor: pointer; }
        .ruling-selector.active { border-color: var(--gold-color); color: var(--gold-color); font-weight: bold; }

        .cross-check {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #555;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
            color: #aaa;
        }
        .cross-check input { width: auto; margin: 0; cursor: pointer; }
        .cross-check label { display: inline; margin: 0; cursor: pointer; color: #aaa; font-weight: normal; }
        .cross-check:hover label { color: #fff; }

        button.add-btn { background-color: var(--success-color); width: 100%; border:none; padding:10px; color:white; border-radius:4px; cursor:pointer; margin-top: 10px; }
        button.add-btn-secondary { background-color: var(--gray-btn-color); width: 100%; border:none; padding:10px; color:white; border-radius:4px; cursor:pointer; margin-top: 5px; }
        button.add-btn-secondary:hover { background-color: #95a5a6; }
        
        /* í…Œë§ˆ ë³€ê²½ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        a.theme-btn {
            display: block;
            width: 100%;
            background-color: var(--theme-btn-color);
            color: white;
            text-align: center;
            padding: 10px;
            border-radius: 4px;
            text-decoration: none;
            font-weight: bold;
            box-sizing: border-box;
            margin-bottom: 20px;
            transition: background 0.2s;
        }
        a.theme-btn:hover { background-color: #7d3c98; }

        button.simulate-btn { background-color: var(--accent-color); width: 100%; padding: 12px; font-size: 1.1em; margin-top: 20px; border:none; color:white; border-radius:4px; cursor:pointer; font-weight:bold;}

        .ideology-list-item {
            display: flex; align-items: center; gap: 10px; background: #222;
            padding: 8px; border-bottom: 1px solid #444; margin-bottom: 5px; border-radius: 4px;
        }
        .order-controls { display: flex; flex-direction: column; gap: 2px; }
        .order-btn { font-size: 0.7em; padding: 0 4px; line-height: 1; cursor: pointer; background: #444; border:none; color:white; }
        .order-btn:hover { background: #666; }

        canvas {
            background: radial-gradient(circle at bottom, #252525, #151515);
            border-radius: 4px;
            width: 100%; max-width: 600px; height: auto;
        }

        .stats-wrapper { margin-top: 15px; border-top: 1px solid #444; padding-top: 15px; }
        .stat-block { background: #222; padding: 12px; border-radius: 6px; border-left: 5px solid #555; margin-bottom: 10px; }
        .stat-title { font-size: 1.1em; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;}
        .stat-legend { display: flex; flex-wrap: wrap; gap: 8px; }
        .legend-pill { background: #333; padding: 4px 10px; border-radius: 12px; font-size: 0.85em; display: flex; align-items: center; gap: 6px; }
    </style>
</head>
<body>

    <div class="controls">
        <h2>ì„¤ì • (Configuration)</h2>
        
        <a href="tno.html" class="theme-btn">ğŸ¨ í…Œë§ˆ ë³€ê²½ (TNO ìŠ¤íƒ€ì¼)</a>

        <div class="form-group">
            <div style="display:flex; gap:15px; margin-bottom: 15px;">
                <label style="font-weight:normal; color:#fff;"><input type="radio" name="systemType" value="bicameral" checked onchange="toggleSystem()"> ì–‘ì›ì œ</label>
                <label style="font-weight:normal; color:#fff;"><input type="radio" name="systemType" value="unicameral" onchange="toggleSystem()"> ë‹¨ì›ì œ</label>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="font-weight:normal; color:#fff; display:flex; align-items:center; gap:5px; cursor:pointer;">
                    <input type="checkbox" id="chkGovHighlight" onchange="simulate()"> 
                    <span>ì§‘ê¶Œ ì„¸ë ¥ ê¸ˆìƒ‰ í…Œë‘ë¦¬ í‘œì‹œ</span>
                </label>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom: 15px; border-bottom:1px solid #444; padding-bottom:15px;">
                <div id="senateConfig">
                    <label>ìƒì› ëª…ì¹­</label>
                    <input type="text" id="senateNameInput" value="ìƒì›" oninput="updateNames()">
                    <label style="margin-top:5px;">ì´ ì˜ì„</label>
                    <input type="number" id="senateTotal" value="100">
                </div>
                <div>
                    <label id="houseNameLabel">í•˜ì› ëª…ì¹­</label>
                    <input type="text" id="houseNameInput" value="í•˜ì›" oninput="updateNames()">
                    <label style="margin-top:5px;">ì´ ì˜ì„</label>
                    <input type="number" id="houseTotal" value="300">
                </div>
            </div>
        </div>

        <div class="tab-container">
            <button class="tab-btn" onclick="switchTab('ideology')" id="tabIdeology">ì´ë… ì„¤ì •</button>
            <button class="tab-btn active" onclick="switchTab('house')" id="tabHouse">í•˜ì› ê´€ë¦¬</button>
            <button class="tab-btn" onclick="switchTab('senate')" id="tabSenate">ìƒì› ê´€ë¦¬</button>
            <button class="tab-btn" onclick="switchTab('coalition')" id="tabCoalition">ì—°ì •/ì§‘ê¶Œ</button>
        </div>

        <div id="contentIdeology" class="tab-content">
            <div style="color:#aaa; font-size:0.9em; margin-bottom:15px;">
                * ìœ„ìª½(â–²)ì´ ì˜íšŒì˜ <strong>ì™¼ìª½(ì¢ŒíŒŒì„)</strong>ì— ë°°ì¹˜ë©ë‹ˆë‹¤.<br>
                * ë¬´ì†Œì† ì´ë…ì€ í•­ìƒ ë¦¬ìŠ¤íŠ¸ì˜ <strong>ë§¨ ë§ˆì§€ë§‰(ì˜¤ë¥¸ìª½)</strong>ì— ë°°ì¹˜ë©ë‹ˆë‹¤.
            </div>
            <div id="ideologyList"></div>
            <button class="add-btn" onclick="addIdeology()">+ ì´ë… ì¶”ê°€</button>
            <button class="add-btn-secondary" onclick="addIndependentIdeology()">+ ë¬´ì†Œì† ì´ë… ì¶”ê°€ (ë§¨ ì˜¤ë¥¸ìª½)</button>
        </div>

        <div id="contentHouse" class="tab-content active">
            <div id="partyListHouse"></div>
            <button class="add-btn" onclick="addParty()">+ ì •ë‹¹ ì¶”ê°€ (ì–‘ì› ê³µí†µ)</button>
            <button class="add-btn-secondary" onclick="addIndependentParty()">+ ë¬´ì†Œì† ì˜ì› ì¶”ê°€</button>
        </div>

        <div id="contentSenate" class="tab-content">
            <div id="partyListSenate"></div>
            <button class="add-btn" onclick="addParty()">+ ì •ë‹¹ ì¶”ê°€ (ì–‘ì› ê³µí†µ)</button>
            <button class="add-btn-secondary" onclick="addIndependentParty()">+ ë¬´ì†Œì† ì˜ì› ì¶”ê°€</button>
        </div>

        <div id="contentCoalition" class="tab-content">
            <div id="coalitionList"></div>
            <button class="add-btn" onclick="addCoalition()">+ ì—°ì • ì¶”ê°€</button>
        </div>

        <button class="simulate-btn" onclick="simulate()">ì‹œë®¬ë ˆì´ì…˜ ì ìš©</button>
    </div>

    <div class="display-area">
        <div class="chamber-box" id="senateSection">
            <h3 id="senateTitle">ìƒì›</h3>
            <canvas id="senateCanvas"></canvas>
            <div id="senateStats" class="stats-wrapper"></div>
        </div>
        <div class="chamber-box">
            <h3 id="houseTitle">í•˜ì›</h3>
            <canvas id="houseCanvas"></canvas>
            <div id="houseStats" class="stats-wrapper"></div>
        </div>
    </div>

    <script>
        const IND_IDEOLOGY_ID = 9999;

        let ideologies = [
            { id: 101, name: "í˜ëª…ì  ì‚¬íšŒì£¼ì˜" },
            { id: 102, name: "ë¯¼ì£¼ì‚¬íšŒì£¼ì˜" },
            { id: 103, name: "ì‚¬íšŒììœ ì£¼ì˜" },
            { id: 104, name: "ììœ ì£¼ì˜" },
            { id: 105, name: "ë³´ìˆ˜ì£¼ì˜" },
            { id: 106, name: "êµ­ê°€ì£¼ì˜" },
            { id: IND_IDEOLOGY_ID, name: "ë¬´ì†Œì†" }
        ];

        let parties = [
            { id: 1, name: "ë…¸ë™ìë‹¹", color: "#8B0000", seatsHouse: 10, seatsSenate: 2, ideologyId: 101, isRuling: false, inHouse: true, inSenate: true },
            { id: 2, name: "ì‚¬íšŒë‹¹", color: "#E91E63", seatsHouse: 40, seatsSenate: 10, ideologyId: 102, isRuling: false, inHouse: true, inSenate: true },
            { id: 3, name: "ë¯¼ì£¼ë‹¹", color: "#3498DB", seatsHouse: 120, seatsSenate: 45, ideologyId: 103, isRuling: false, inHouse: true, inSenate: true },
            { id: 4, name: "êµ­ë¯¼ë‹¹", color: "#E74C3C", seatsHouse: 80, seatsSenate: 30, ideologyId: 105, isRuling: false, inHouse: true, inSenate: true },
            { id: 5, name: "ì§€ì—­ë‹¹", color: "#F1C40F", seatsHouse: 20, seatsSenate: 0, ideologyId: 104, isRuling: false, inHouse: true, inSenate: false }, 
            { id: 6, name: "ê·€ì¡±ì›", color: "#8E44AD", seatsHouse: 0, seatsSenate: 10, ideologyId: 106, isRuling: false, inHouse: false, inSenate: true } 
        ];

        let coalitions = [
            { id: 'c1', name: "ë¯¼ì£¼ ì—°ì •", color: "#3498DB", members: [2, 3], isRuling: true },
            { id: 'c2', name: "ë³´ìˆ˜ ì—°í•©", color: "#E74C3C", members: [4], isRuling: false }
        ];

        let currentTab = 'house';

        window.onload = function() { 
            toggleSystem(); 
            refreshUI();
            simulate(); 
        };

        function switchTab(tabName) {
            currentTab = tabName;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('content' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
            refreshUI();
        }

        function toggleSystem() {
            const isBicameral = document.querySelector('input[name="systemType"]:checked').value === 'bicameral';
            document.getElementById('senateConfig').style.display = isBicameral ? 'block' : 'none';
            document.getElementById('senateSection').style.display = isBicameral ? 'block' : 'none';
            document.getElementById('tabSenate').style.display = isBicameral ? 'block' : 'none';
            document.getElementById('houseNameLabel').textContent = isBicameral ? "í•˜ì› ëª…ì¹­" : "ì˜íšŒ ëª…ì¹­";
            document.getElementById('tabHouse').textContent = isBicameral ? "í•˜ì› ê´€ë¦¬" : "ì˜ì„ ê´€ë¦¬";
            if(!isBicameral && currentTab === 'senate') switchTab('house');
            updateNames();
        }

        function updateNames() {
            const sName = document.getElementById('senateNameInput').value;
            const hName = document.getElementById('houseNameInput').value;
            document.getElementById('senateTitle').textContent = sName;
            document.getElementById('houseTitle').textContent = hName;
            document.getElementById('tabHouse').textContent = 
                document.querySelector('input[name="systemType"]:checked').value === 'bicameral' 
                ? hName + " ê´€ë¦¬" : "ì˜ì„ ê´€ë¦¬";
            document.getElementById('tabSenate').textContent = sName + " ê´€ë¦¬";
        }

        function refreshUI() {
            renderIdeologyList();
            renderPartyList('house');
            renderPartyList('senate');
            renderCoalitions();
        }

        function isValidHex(hex) { return /^#[0-9A-F]{6}$/i.test(hex); }

        function renderIdeologyList() {
            const container = document.getElementById('ideologyList');
            container.innerHTML = '';
            ideologies.forEach((ide, index) => {
                const div = document.createElement('div');
                div.className = 'ideology-list-item';
                div.innerHTML = `
                    <div class="order-controls">
                        <button class="order-btn" onclick="moveIdeology(${index}, -1)" ${index === 0 ? 'disabled' : ''}>â–²</button>
                        <button class="order-btn" onclick="moveIdeology(${index}, 1)" ${index === ideologies.length - 1 ? 'disabled' : ''}>â–¼</button>
                    </div>
                    <input type="text" value="${ide.name}" onchange="updateIdeology(${index}, 'name', this.value)" style="flex:1;">
                    <button class="btn-icon danger" onclick="removeIdeology(${index})">X</button>
                `;
                container.appendChild(div);
            });
        }

        function renderPartyList(type) {
            const container = document.getElementById(type === 'house' ? 'partyListHouse' : 'partyListSenate');
            container.innerHTML = '';

            const visibleParties = parties.map((p, idx) => ({ ...p, originalIdx: idx }))
                                            .filter(p => type === 'house' ? p.inHouse : p.inSenate);

            visibleParties.forEach((p) => {
                const idx = p.originalIdx;
                const div = document.createElement('div');
                div.className = `card-item ${p.isRuling ? 'is-ruling' : ''}`;
                div.style.borderLeftColor = p.color;

                const seatKey = type === 'house' ? 'seatsHouse' : 'seatsSenate';
                const seatLabel = type === 'house' ? 'í•˜ì› ì˜ì„' : 'ìƒì› ì˜ì„';
                
                let crossCheckHtml = '';
                if (type === 'house') {
                    crossCheckHtml = `
                        <div class="cross-check">
                            <input type="checkbox" id="linkSen${idx}" ${p.inSenate ? 'checked' : ''} onchange="togglePartyParticipation(${idx}, 'inSenate', this.checked)">
                            <label for="linkSen${idx}">ìƒì›(Senate)ì—ë„ ì°¸ì—¬</label>
                        </div>
                    `;
                } else {
                    crossCheckHtml = `
                        <div class="cross-check">
                            <input type="checkbox" id="linkHou${idx}" ${p.inHouse ? 'checked' : ''} onchange="togglePartyParticipation(${idx}, 'inHouse', this.checked)">
                            <label for="linkHou${idx}">í•˜ì›(House)ì—ë„ ì°¸ì—¬</label>
                        </div>
                    `;
                }

                div.innerHTML = `
                    <div class="card-header">
                        <input type="text" value="${p.name}" onchange="updateParty(${idx}, 'name', this.value)" style="flex:1;" placeholder="ë‹¹ëª…">
                        <div class="color-input-group">
                            <input type="text" class="hex-input" value="${p.color}" onchange="updatePartyColorText(this, ${idx})" placeholder="#Hex">
                            <input type="color" value="${p.color}" oninput="updatePartyColorPicker(this, ${idx})">
                        </div>
                        <button class="remove-btn" onclick="removeParty(${idx})" title="ì–‘ì› ëª¨ë‘ì—ì„œ ì˜êµ¬ ì‚­ì œ">ì‚­ì œ</button>
                    </div>
                    <div class="party-grid">
                        <div class="full-width">
                            <label>ì´ë…</label>
                            <select onchange="updateParty(${idx}, 'ideologyId', parseInt(this.value))">
                                ${ideologies.map(ide => `<option value="${ide.id}" ${p.ideologyId === ide.id ? 'selected' : ''}>${ide.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="full-width" style="display:flex; gap:10px;">
                            <div style="flex:1;">
                                <label style="color:${type==='house'?'#4a90e2':'#e67e22'}">${seatLabel}</label>
                                <input type="number" value="${p[seatKey]}" min="0" onchange="updateParty(${idx}, '${seatKey}', parseInt(this.value)||0)">
                            </div>
                        </div>
                    </div>
                    ${crossCheckHtml}
                `;
                container.appendChild(div);
            });
            
            if (visibleParties.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#666; padding:20px;">ë“±ë¡ëœ ì •ë‹¹ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        function renderCoalitions() {
            const container = document.getElementById('coalitionList');
            container.innerHTML = '';
            coalitions.forEach((coal, cIdx) => {
                const div = document.createElement('div');
                div.className = `card-item ${coal.isRuling ? 'is-ruling' : ''}`;
                div.style.borderLeftColor = coal.color;
                let memberChecks = '';
                parties.forEach(p => {
                    const isChecked = coal.members.includes(p.id);
                    let badges = [];
                    if(p.inHouse) badges.push("í•˜");
                    if(p.inSenate) badges.push("ìƒ");
                    const badgeStr = badges.length ? `[${badges.join('+')}]` : `[ë¯¸ì°¸ì—¬]`;

                    memberChecks += `
                        <div class="member-check">
                            <span class="party-badge" style="background:${p.color}"></span>
                            <label for="c${cIdx}_p${p.id}">
                                ${p.name} <span style="color:#aaa; font-size:0.8em;">${badgeStr}</span>
                            </label>
                            <input type="checkbox" id="c${cIdx}_p${p.id}" 
                                ${isChecked ? 'checked' : ''} 
                                onchange="toggleCoalitionMember('${coal.id}', ${p.id}, this.checked)">
                        </div>
                    `;
                });
                div.innerHTML = `
                    <div class="card-header">
                        <input type="text" value="${coal.name}" onchange="updateCoalition('${coal.id}', 'name', this.value)" style="flex:1;" placeholder="ì—°ì • ì´ë¦„">
                        <div class="color-input-group">
                            <input type="text" class="hex-input" value="${coal.color}" onchange="updateCoalitionColorText(this, '${coal.id}')">
                            <input type="color" value="${coal.color}" oninput="updateCoalitionColorPicker(this, '${coal.id}')">
                        </div>
                        <button class="remove-btn" onclick="removeCoalition('${coal.id}')">ì‚­ì œ</button>
                    </div>
                    <label class="ruling-selector ${coal.isRuling ? 'active' : ''}" style="margin-bottom:10px;">
                        <input type="radio" name="global_ruling" ${coal.isRuling ? 'checked' : ''} onchange="setRuling('coalition', '${coal.id}')">
                        ${coal.isRuling ? 'âœ” ì§‘ê¶Œ ì—°ì • (Government)' : 'ì§‘ê¶Œ ì—°ì •ìœ¼ë¡œ ì„¤ì •'}
                    </label>
                    <div class="coalition-members">${memberChecks}</div>
                `;
                container.appendChild(div);
            });
            
            const partyGovDiv = document.createElement('div');
            partyGovDiv.style.marginTop = "20px";
            partyGovDiv.style.borderTop = "1px solid #444";
            partyGovDiv.style.paddingTop = "10px";
            partyGovDiv.innerHTML = "<h4>ë‹¨ë… ì§‘ê¶Œ ì„¤ì •</h4>";
            
            parties.forEach(p => {
                const pDiv = document.createElement('div');
                pDiv.className = `ruling-selector ${p.isRuling ? 'active' : ''}`;
                pDiv.style.marginBottom = "5px";
                pDiv.innerHTML = `
                    <span class="party-badge" style="background:${p.color}"></span>
                    <span style="flex:1">${p.name}</span>
                    <input type="radio" name="global_ruling" ${p.isRuling ? 'checked' : ''} onchange="setRuling('party', ${p.id})">
                `;
                partyGovDiv.appendChild(pDiv);
            });
            container.appendChild(partyGovDiv);
        }

        function addIdeology() { ideologies.push({ id: Date.now(), name: "ìƒˆ ì´ë…" }); refreshUI(); }
        
        function addIndependentIdeology() {
            const existing = ideologies.find(i => i.id === IND_IDEOLOGY_ID);
            if (existing) {
                ideologies = ideologies.filter(i => i.id !== IND_IDEOLOGY_ID);
                ideologies.push(existing);
            } else {
                ideologies.push({ id: IND_IDEOLOGY_ID, name: "ë¬´ì†Œì†" });
            }
            refreshUI(); simulate();
        }

        function removeIdeology(index) {
            if(ideologies.length <= 1) { alert("ìµœì†Œ 1ê°œì˜ ì´ë…ì€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤."); return; }
            const removedId = ideologies[index].id; ideologies.splice(index, 1);
            parties.forEach(p => { if(p.ideologyId === removedId) p.ideologyId = ideologies[0].id; });
            refreshUI(); simulate();
        }
        function updateIdeology(index, key, val) { ideologies[index][key] = val; refreshUI(); simulate(); }
        function moveIdeology(index, direction) {
            if (direction === -1 && index > 0) { [ideologies[index], ideologies[index - 1]] = [ideologies[index - 1], ideologies[index]]; } 
            else if (direction === 1 && index < ideologies.length - 1) { [ideologies[index], ideologies[index + 1]] = [ideologies[index + 1], ideologies[index]]; }
            refreshUI(); simulate();
        }

        function addParty() {
            parties.push({ id: Date.now(), name: "ì‹ ë‹¹", color: "#999999", seatsHouse: 0, seatsSenate: 0, ideologyId: ideologies[0].id, isRuling: false, inHouse: true, inSenate: true });
            refreshUI();
        }

        function addIndependentParty() {
            let indIdeology = ideologies.find(i => i.id === IND_IDEOLOGY_ID);
            if (!indIdeology) {
                addIndependentIdeology();
                indIdeology = ideologies.find(i => i.id === IND_IDEOLOGY_ID);
            }
            parties.push({ id: Date.now(), name: "ë¬´ì†Œì†", color: "#AAAAAA", seatsHouse: 1, seatsSenate: 0, ideologyId: IND_IDEOLOGY_ID, isRuling: false, inHouse: true, inSenate: true });
            refreshUI(); simulate();
        }

        function removeParty(idx) {
            const pId = parties[idx].id;
            parties.splice(idx, 1);
            coalitions.forEach(c => { c.members = c.members.filter(id => id !== pId); });
            refreshUI(); simulate();
        }
        function updateParty(idx, key, val) {
            parties[idx][key] = val;
            if (key === 'name') refreshUI(); 
            simulate();
        }
        function togglePartyParticipation(idx, field, isChecked) {
            parties[idx][field] = isChecked;
            refreshUI(); simulate();
        }

        function updatePartyColorText(el, idx) {
            let v = el.value.trim(); if(!v.startsWith('#')) v = '#'+v;
            if(isValidHex(v)) { 
                parties[idx].color = v.toUpperCase(); 
                el.parentElement.querySelector('input[type="color"]').value = v.substring(0,7); 
                refreshUI(); simulate(); 
            }
        }
        function updatePartyColorPicker(el, idx) {
            parties[idx].color = el.value.toUpperCase();
            el.parentElement.querySelector('.hex-input').value = el.value.toUpperCase(); 
            simulate(); 
        }

        function addCoalition() { coalitions.push({ id: 'c'+Date.now(), name: "ìƒˆ ì—°ì •", color: "#FFFFFF", members: [], isRuling: false }); refreshUI(); }
        function removeCoalition(id) { coalitions = coalitions.filter(c => c.id !== id); refreshUI(); simulate(); }
        function updateCoalition(id, key, val) { const c = coalitions.find(c => c.id === id); if(c) { c[key] = val; simulate(); } }
        
        function updateCoalitionColorText(el, id) {
            let v = el.value.trim(); if(!v.startsWith('#')) v = '#'+v;
            if(isValidHex(v)) { 
                const c = coalitions.find(x => x.id === id); 
                if(c) { 
                    c.color = v.toUpperCase(); 
                    el.parentElement.querySelector('input[type="color"]').value = v.substring(0,7);
                    simulate(); 
                } 
            }
        }
        function updateCoalitionColorPicker(el, id) {
            const c = coalitions.find(x => x.id === id); 
            if(c) { 
                c.color = el.value.toUpperCase(); 
                el.parentElement.querySelector('.hex-input').value = el.value.toUpperCase();
                simulate(); 
            }
        }

        function toggleCoalitionMember(cId, pId, checked) {
            if(checked) { coalitions.forEach(c => c.members = c.members.filter(id => id !== pId)); const t = coalitions.find(c => c.id === cId); if(t) t.members.push(pId); } 
            else { const t = coalitions.find(c => c.id === cId); if(t) t.members = t.members.filter(id => id !== pId); }
            refreshUI(); simulate();
        }
        function setRuling(type, id) {
            parties.forEach(p => p.isRuling = false); coalitions.forEach(c => c.isRuling = false);
            if(type === 'party') { const p = parties.find(x => x.id === id); if(p) p.isRuling = true; }
            else if(type === 'coalition') { const c = coalitions.find(x => x.id === id); if(c) c.isRuling = true; }
            refreshUI(); simulate();
        }

        function simulate() {
            const isBicameral = document.querySelector('input[name="systemType"]:checked').value === 'bicameral';
            const highlightGov = document.getElementById('chkGovHighlight').checked;

            const sTotal = parseInt(document.getElementById('senateTotal').value) || 100;
            const hTotal = parseInt(document.getElementById('houseTotal').value) || 300;

            parties.sort((a, b) => {
                const idxA = ideologies.findIndex(i => i.id === a.ideologyId);
                const idxB = ideologies.findIndex(i => i.id === b.ideologyId);
                if (a.ideologyId === IND_IDEOLOGY_ID && b.ideologyId !== IND_IDEOLOGY_ID) return 1;
                if (b.ideologyId === IND_IDEOLOGY_ID && a.ideologyId !== IND_IDEOLOGY_ID) return -1;
                return idxA - idxB;
            });

            const getMap = (targetTotal, chamberKey, checkKey) => {
                const activeParties = parties.filter(p => p[checkKey]);
                let map = [];
                
                activeParties.forEach((p) => {
                    const count = p[chamberKey]; 
                    
                    const coal = coalitions.find(c => c.members.includes(p.id));
                    const isGov = (coal && coal.isRuling) || p.isRuling;
                    
                    let stroke = null;
                    if (highlightGov && isGov) {
                        stroke = "#f1c40f";
                    } else if (coal) {
                        stroke = coal.color;
                    }

                    const ideName = ideologies.find(ide => ide.id === p.ideologyId)?.name || "";

                    for(let k=0; k < count; k++) {
                        if (map.length >= targetTotal) break;
                        map.push({
                            color: p.color, 
                            partyName: p.name, 
                            ideology: ideName,
                            coalitionName: coal ? coal.name : null, 
                            coalitionId: coal ? coal.id : null,
                            strokeColor: stroke, 
                            isRuling: isGov
                        });
                    }
                });

                while(map.length < targetTotal) {
                    map.push({ 
                        color: '#333',
                        partyName: 'ê³µì„',
                        ideology: '-',
                        coalitionName: null,
                        coalitionId: 'vacant', 
                        strokeColor: '#444',
                        isRuling: false
                    });
                }
                
                return map;
            };

            const hMap = getMap(hTotal, 'seatsHouse', 'inHouse');
            drawChamber('houseCanvas', hMap, hTotal);
            updateStats('houseStats', hMap, hTotal);

            if (isBicameral) {
                const sMap = getMap(sTotal, 'seatsSenate', 'inSenate');
                drawChamber('senateCanvas', sMap, sTotal);
                updateStats('senateStats', sMap, sTotal);
            }
        }

        function drawChamber(canvasId, seatMap, totalSeats) {
            const canvas = document.getElementById(canvasId);
            const containerWidth = canvas.parentElement.clientWidth - 40;
            canvas.width = containerWidth;
            canvas.height = containerWidth / 2 + 50;
            const ctx = canvas.getContext('2d');
            const CX = canvas.width / 2;
            const CY = canvas.height - 25;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if(totalSeats <= 0) return;

            const minR = canvas.width * 0.18;
            const maxR = (canvas.width / 2) - 10;
            let bestConfig = null;
            let low = 2, high = 15;
            for(let i=0; i<20; i++) {
                let mid = (low + high) / 2;
                let cfg = calculateRows(mid, minR, maxR, totalSeats);
                if(cfg.totalCapacity >= totalSeats) { bestConfig = cfg; low = mid; }
                else { high = mid; }
            }
            if(!bestConfig) bestConfig = calculateRows(low, minR, maxR, totalSeats);

            const { rows, dotR } = bestConfig;
            let allPoints = [];
            let distRows = rows.map(r => ({ ...r, actual: Math.round(totalSeats * (r.circumference / bestConfig.totalCircumference)) }));
            let sum = distRows.reduce((a,b)=>a+b.actual, 0);
            distRows[distRows.length-1].actual += (totalSeats - sum);

            const startAngle = Math.PI - 0.05; const endAngle = 0.05; const span = startAngle - endAngle;

            distRows.forEach(row => {
                if(row.actual <= 0) return;
                for(let i=0; i<row.actual; i++) {
                    let ang = (row.actual===1) ? Math.PI/2 : startAngle - (span * (i / (row.actual-1)));
                    allPoints.push({ x: CX + row.radius * Math.cos(ang), y: CY - row.radius * Math.sin(ang), angle: ang });
                }
            });

            allPoints.sort((a,b) => b.angle - a.angle);
            allPoints.forEach((pt, i) => {
                if(i >= seatMap.length) return;
                const d = seatMap[i];
                ctx.beginPath(); ctx.arc(pt.x, pt.y, dotR, 0, Math.PI*2); ctx.fillStyle = d.color; ctx.fill();
                
                // í…Œë‘ë¦¬ ë‘ê»˜ 70% ìˆ˜ì¤€ìœ¼ë¡œ ê°ì†Œ
                if(d.strokeColor) { ctx.strokeStyle = d.strokeColor; ctx.lineWidth = Math.max(1.0, dotR * 0.28); } 
                else { ctx.strokeStyle = "rgba(0,0,0,0.3)"; ctx.lineWidth = 1; }
                ctx.stroke();
            });
            ctx.fillStyle = "#fff"; ctx.textAlign = "center"; ctx.textBaseline = "bottom";
            ctx.font = "bold 26px Arial"; ctx.fillText(totalSeats, CX, CY - 10);
            ctx.font = "14px Arial"; ctx.fillStyle = "#888"; ctx.fillText("Total Seats", CX, CY + 10);
        }

        function calculateRows(dotR, minR, maxR, target) {
            const rowH = dotR * 2.5; const avail = maxR - minR;
            let cnt = Math.floor(avail / rowH); if(cnt < 1) cnt = 1;
            const startR = minR + (avail - cnt*rowH)/2 + dotR;
            let rows = [], cap = 0, circSum = 0;
            for(let i=0; i<cnt; i++) {
                const r = startR + i*rowH; const circ = Math.PI * r; const c = Math.floor(circ / (dotR*2.5));
                rows.push({ radius: r, capacity: c, circumference: circ }); cap += c; circSum += circ;
            }
            return { rows, totalCapacity: cap, totalCircumference: circSum, dotR };
        }

        function updateStats(elId, map, total) {
            const el = document.getElementById(elId);
            if(total === 0) { el.innerHTML = ""; return; }
            
            const highlightGov = document.getElementById('chkGovHighlight').checked;

            let stats = {};
            coalitions.forEach(c => { stats[c.id] = { type: 'coalition', id: c.id, name: c.name, color: c.color, count: 0, parties: {}, isRuling: c.isRuling }; });
            parties.forEach(p => { if(p.isRuling && !coalitions.some(c => c.members.includes(p.id))) { stats['p_'+p.id] = { type: 'party', id: p.id, name: p.name, color: p.color, count: 0, parties: {}, isRuling: true }; } });
            
            stats['none'] = { type: 'none', id: 'none', name: 'ì—°ì • ë¯¸ì†Œì†', color: '#777', count: 0, parties: {}, isRuling: false };
            stats['vacant'] = { type: 'vacant', id: 'vacant', name: 'ê³µì„ (ë¯¸ë°°ì •)', color: '#444', count: 0, parties: {}, isRuling: false };

            map.forEach(s => {
                let key = 'none';
                if(s.coalitionId === 'vacant') key = 'vacant';
                else if(s.coalitionId) key = s.coalitionId;
                else if(parties.find(p => p.name === s.partyName)?.isRuling) key = 'p_' + parties.find(p => p.name === s.partyName).id;
                
                if(!stats[key]) key = 'none';
                stats[key].count++;
                if(!stats[key].parties[s.partyName]) stats[key].parties[s.partyName] = { n:0, col: s.color, ide: s.ideology };
                stats[key].parties[s.partyName].n++;
            });

            // ê³¼ë°˜ ê³„ì‚° (ê³µì„ ì œì™¸)
            const vacantCount = stats['vacant'] ? stats['vacant'].count : 0;
            const activeSeats = total - vacantCount;
            const maj = Math.floor(activeSeats / 2) + 1;

            const sortedKeys = Object.keys(stats).sort((a,b) => {
                if(a==='vacant') return 1; if(b==='vacant') return -1;
                if(stats[a].isRuling) return -1; if(stats[b].isRuling) return 1;
                return stats[b].count - stats[a].count;
            });

            let html = "";
            sortedKeys.forEach(key => {
                const group = stats[key];
                if(group.count === 0) return;
                const percent = ((group.count / total) * 100).toFixed(1);
                const isMaj = group.count >= maj;
                let statusBadge = '';
                
                const useGold = group.isRuling && highlightGov;
                const isVacant = key === 'vacant';

                if (group.isRuling) {
                    const badgeBg = useGold ? 'var(--gold-color)' : group.color;
                    const badgeTxt = useGold ? '#000' : '#fff'; 
                    
                    const govTitle = `<span style="background:${badgeBg}; color:${badgeTxt}; font-size:0.7em; padding:2px 6px; border-radius:4px; margin-right:5px; font-weight:bold; text-shadow:${useGold ? 'none' : '0 0 2px rgba(0,0,0,0.5)'}">ì§‘ê¶Œ</span>`;

                    if (isMaj) statusBadge = `${govTitle} <span style="color:var(--success-color); font-size:0.8em; margin-left:10px;">âœ” ê³¼ë°˜ í™•ë³´</span> <span style="color:#888; font-size:0.7em;">(í•„ìš”: ${maj} / ìœ íš¨: ${activeSeats})</span>`;
                    else statusBadge = `${govTitle} <span style="color:var(--danger-color); font-size:0.8em; margin-left:10px;">âš  ê³¼ë°˜ ë¯¸ë‹¬</span> <span style="color:#888; font-size:0.7em;">(í•„ìš”: ${maj} / ìœ íš¨: ${activeSeats})</span>`;
                } else if (key !== 'vacant' && isMaj) {
                    statusBadge = `<span style="color:var(--warning-color); font-size:0.8em; margin-left:10px;">âš¡ ê³¼ë°˜ ì¥ì•… (ì—¬ì†Œì•¼ëŒ€)</span> <span style="color:#888; font-size:0.7em;">(í•„ìš”: ${maj} / ìœ íš¨: ${activeSeats})</span>`;
                }

                let legendHtml = '';
                for(const [pName, pData] of Object.entries(group.parties)) {
                    legendHtml += `<div class="legend-pill" title="${pData.ide}"><span class="party-badge" style="background:${pData.col}; border: 1px solid ${group.type==='coalition' ? group.color : 'transparent'}"></span>${pName} <span style="color:#888; margin-left:3px; font-size:0.9em;">(${pData.ide})</span>: <strong>${pData.n}</strong></div>`;
                }
                
                const borderColor = isVacant ? '#444' : (useGold ? 'var(--gold-color)' : group.color);
                const bgColor = isVacant ? '#1a1a1a' : (useGold ? 'linear-gradient(90deg, #2a2a20 0%, #222 100%)' : '#222');
                const titleColor = isVacant ? '#888' : borderColor;

                html += `<div class="stat-block" style="border-left: 5px solid ${borderColor}; background: ${bgColor}">
                            <div class="stat-title">
                                <span><strong style="color:${titleColor}">${group.name}</strong> <span style="color:#aaa; font-size:0.9em;">(${group.count}ì„ / ${percent}%)</span></span>
                                ${statusBadge}
                            </div>
                            <div class="stat-legend">${legendHtml}</div>
                        </div>`;
            });
            el.innerHTML = html;
        }
    </script>
</body>
</html>
